@page "/sentence10/ViewDetail/{id:Guid}"
@using System.Globalization
@using PracticeInternship.Application.DTOs
@using PracticeInternship.WebUI.Components.Pages.Sentence1
@inject PracticeInternship.Application.Interfaces.Interface_DM_Nhap_Kho NhapKhoInterface
@inject PracticeInternship.Application.Interfaces.Interface_DM_Kho KhoInterface
@inject PracticeInternship.Application.Interfaces.Interface_DM_NCC NCCInterface
@inject PracticeInternship.Application.Interfaces.Interface_DM_Nhap_Kho_Raw_Data DMNhapKhoRawDataInterface
@inject NavigationManager NavigationManager
@inject IToastService ToastService

<PageTitle>Thông tin phiếu nhập kho</PageTitle>
@{
    var culture = CultureInfo.GetCultureInfo("en-US");
    culture = (CultureInfo)culture.Clone();
    culture.NumberFormat.CurrencySymbol = "";
}
@if (dM_Nhap_Kho_Detail_Response != null)
{

    <div class="row">
        <div class="col">
            <div>Đơn vị: </div>
            <div>Bộ phận: </div>
            <div>@dM_Nhap_Kho_Detail_Response!.Ngay_Nhap_kho.ToString("'Ngày' dd 'tháng' MM 'năm' yyyy", CultureInfo.GetCultureInfo("vi-VN"))</div>
            <div>Số phiếu nhập: @dM_Nhap_Kho_Detail_Response!.So_Phieu_Nhap_Kho</div>
        </div>
        <div class="col">
            <h2 class="d-flex justify-content-center fw-bold">PHIẾU NHẬP KHO</h2>
            <div class="text-end" style="margin-right: 30px;">Nợ: ...................................................</div>
            <div class="text-end" style="margin-right: 30px;">Có: ...................................................</div>
        </div>
        <div class="col">
            <h3 class="text-end fw-bold">Mẫu số : 01 - VT</h3>
            <div class="text-end" style="font-size:13px; margin-left:150px;">(Ban Hành theo QĐ Số 15/2006/QĐ-BTC Ngày 20/03/2006 của Bộ Trưởng BTC)</div>
        </div>
    </div>
    <div>Họ tên người giao hàng: </div>
    <div class="row">
        <div class="col">
            <div>Theo TK số: </div>
            <div class="mb-2">Nhập tại kho: @dM_Nhap_Kho_Detail_Response!.Ten_Kho</div>
        </div>
        <div class="col">
            <div>@dM_Nhap_Kho_Detail_Response!.Ngay_Nhap_kho.ToString("'Ngày' dd 'tháng' MM 'năm' yyyy", CultureInfo.GetCultureInfo("vi-VN")) của ...</div>
            <div>Địa Điểm: </div>
        </div>
        <div class="col"></div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead class="table-primary">
                <tr>
                    <th style="width: 50px;">STT</th>
                    <th style="width: 325px;">Tên nhãn hiệu, quy cách, phẩm chất, vật tư, dụng cụ, sản phẩm, hàng hóa</th>
                    <th style="width: 175px;">Mã sản phẩm</th>
                    <th style="width: 145px;">Đơn vị tính</th>
                    <th style="width: 100px;">Số lượng</th>
                    <th style="width: 125px;">Đơn giá</th>
                    <th style="width: 175px;">Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                <tr class="table-primary">
                    <td>
                        A
                    </td>
                    <td>B</td>
                    <td>C</td>
                    <td>D</td>
                    <td>1</td>
                    <td>2</td>
                    <td>
                        3
                    </td>
                </tr>
                @if (dM_Nhap_Kho_Raw_Data_Response != null)
                {
                    var count = 0;
                    @foreach (var product in dM_Nhap_Kho_Raw_Data_Response)
                    {
                        <tr>
                            <td>
                                @{
                                    count = count + 1;
                                }
                                @count
                            </td>
                            <td>@product.Ten_San_Pham</td>
                            <td>@product.Ma_San_Pham</td>
                            <td>@product.Ten_Don_Vi_Tinh</td>
                            <td>@product.SL_Nhap</td>
                            <td>@product.Don_Gia_Nhap.ToString("C", culture)</td>
                            <td>
                                @{
                                    var total = product.SL_Nhap * product.Don_Gia_Nhap;
                                    var format = total.ToString("C", culture);
                                }
                                @format
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6"><em>Không có dữ liệu</em></td>
                    </tr>
                }
            </tbody>
            <tfoot class="table-primary">
                <tr>
                    <td colspan="4" class="fw-bold">Tổng</td>
                    <td class="fw-bold">
                        @{
                            var sumSLNhap = 0;
                        }
                        @if (dM_Nhap_Kho_Raw_Data_Response != null && dM_Nhap_Kho_Raw_Data_Response.Any())
                        {
                            @* dM_Nhap_Kho_Raw_Data_Response.Sum(p => p.SL_Nhap); *@

                            @foreach (var product in dM_Nhap_Kho_Raw_Data_Response)
                            {
                                sumSLNhap = sumSLNhap + product.SL_Nhap;
                            }
                        }
                        @sumSLNhap
                    </td>
                    <td></td>
                    <td class="fw-bold">
                        @{
                            decimal sumDonGiaNhap = 0;
                        }
                        @if (dM_Nhap_Kho_Raw_Data_Response != null)
                        {
                            @* dM_Nhap_Kho_Raw_Data_Response.Sum(p => p.SL_Nhap * p.Don_Gia_Nhap).ToString("C", CultureInfo.GetCultureInfo("vi-VN")); *@
                            @foreach (var product in dM_Nhap_Kho_Raw_Data_Response)
                            {
                                sumDonGiaNhap = sumDonGiaNhap + (product.SL_Nhap * product.Don_Gia_Nhap);
                            }
                        }
                        @sumDonGiaNhap.ToString("C", culture)
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
    <div class="row">
        <div class="d-flex align-items-center">
            <div class="fw-bold">Tổng Số Tiền (Viết bằng chữ) : </div>
            <div class="fw-bold" style="margin-left: 20px;">@NumberToWords(sumDonGiaNhap)</div>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col">
            <div class="fw-bold">Số Chứng Từ Gốc Kèm Theo: </div>
        </div>
        <div class="col" style="font-size: 14px;">Ngày  .......  Tháng  .......  Năm  .......</div>
    </div>

    <div class="row text-center">
        <div class="col">
            <div class="fw-bold">
                Người Lập Phiếu
            </div>
            <div style="font-size: 14px;">
                (Ký, họ tên)
            </div>
        </div>

        <div class="col">
            <div class="fw-bold">
                Người Giao Hàng
            </div>
            <div style="font-size: 14px;">
                (Ký, họ tên)
            </div>
        </div>

        <div class="col">
            <div class="fw-bold">
                Thủ Kho
            </div>
            <div style="font-size: 14px;">
                (Ký, họ tên)
            </div>
        </div>

        <div class="col">
            <div class="fw-bold">
                Kế Toán Trưởng
            </div>
            <div style="font-size: 14px;">
                (Ký, họ tên)
            </div>
        </div>
    </div>
}

@code {
    #region View detail
    [Parameter]
    public string? Id { get; set; }

    [SupplyParameterFromForm]
    public DM_Nhap_Kho_Detail_Response? dM_Nhap_Kho_Detail_Response { get; set; }
    public ICollection<DM_Nhap_Kho_Raw_Data_Response>? dM_Nhap_Kho_Raw_Data_Response { get; set; }
    public IEnumerable<DM_Kho>? khos { get; set; }
    public IEnumerable<DM_NCC>? nccs { get; set; }

    protected override async Task OnInitializedAsync()
    {
        dM_Nhap_Kho_Detail_Response ??= await NhapKhoInterface.GetDetailOfNhapKhoById(Guid.Parse(Id!));
        dM_Nhap_Kho_Raw_Data_Response = dM_Nhap_Kho_Detail_Response.List_DM_Nhap_Kho_Raw_Data_Response;
        khos = await KhoInterface.GetAllAsync();
        nccs = await NCCInterface.GetAllAsync();
    }
    #endregion

    #region ConvertCurrencyText helper
    public static string NumberToWords(decimal number)
    {
        if (number == 0)
            return "không đồng";

        string[] units = { "", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín" };
        string[] levels = { "", "nghìn", "triệu", "tỷ" };

        string result = "";
        int levelIndex = 0;

        long integerPart = (long)Math.Floor(number); // Lấy phần nguyên
        int fractionalPart = (int)((number - integerPart) * 100); // Lấy phần thập phân (2 chữ số)

        while (integerPart > 0)
        {
            int group = (int)(integerPart % 1000); // Lấy từng nhóm 3 số
            integerPart /= 1000;

            if (group > 0)
            {
                string groupWords = ConvertGroupToWords(group, units);
                result = $"{groupWords} {levels[levelIndex]} {result}".Trim();
            }

            levelIndex++;
        }

        result = $"{result.Trim()} USD";

        if (fractionalPart > 0)
        {
            result += $" và {ConvertGroupToWords(fractionalPart, units)} xu";
        }

        return char.ToUpper(result[0]) + result.Substring(1).Trim();
    }

    private static string ConvertGroupToWords(int group, string[] units)
    {
        string result = "";

        int hundreds = group / 100;
        int tens = (group % 100) / 10;
        int ones = group % 10;

        if (hundreds > 0)
            result += $"{units[hundreds]} trăm ";

        if (tens > 1)
        {
            result += $"{units[tens]} mươi ";
            if (ones > 0)
                result += units[ones];
        }
        else if (tens == 1)
        {
            result += "mười ";
            if (ones > 0)
                result += units[ones];
        }
        else
        {
            if (ones > 0)
                result += $"lẻ {units[ones]}";
        }

        return result.Trim();
    }
    #endregion
}

